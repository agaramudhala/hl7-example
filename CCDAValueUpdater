package org.example;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class CCDAValueUpdater {
    public static void main(String[] args) {
        String ccdaFilePath = "src/main/java/org/example/ccda.xml";

        // Read the CCDA XML file as a string
        String ccdaContent = readCCDAFile(ccdaFilePath);
        System.out.println(ccdaContent);
        // Update the values
        String newGivenName = "New Given Name";
        String newLastName = "New Last Name";
        String newDob = "New Date of Birth";

        ccdaContent = updateValue(ccdaContent, "/ClinicalDocument/recordTarget/patientRole/patient/name[1]/given[1]", newGivenName);
        ccdaContent = updateValue(ccdaContent, "/ClinicalDocument/recordTarget/patientRole/patient/name[1]/family[1]", newLastName);
        ccdaContent = updateValue(ccdaContent, "/ClinicalDocument/recordTarget/patientRole/patient/birthTime", newDob);

        // Save the updated CCDA file
        saveCCDAFile(ccdaContent, ccdaFilePath);

        System.out.println("CCDA file has been updated successfully.");

        System.out.println(ccdaContent);
    }

    private static String readCCDAFile(String filePath) {
        try {
            return new String(Files.readAllBytes(Paths.get(filePath)));
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
    }

    private static void saveCCDAFile(String content, String filePath) {
        try (FileWriter writer = new FileWriter(new File(filePath))) {
            writer.write(content);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static String updateValue(String xmlContent, String xpath, String newValue) {
        // Escape special characters in the XPath expression
        String escapedXPath = Pattern.quote(xpath);

        // Create a regex pattern to match the XPath expression
        Pattern pattern = Pattern.compile("(<" + escapedXPath + ">)(.*?)(</" + escapedXPath + ">)", Pattern.DOTALL);
        Matcher matcher = pattern.matcher(xmlContent);

        // Replace the matched value with the new value
        if (matcher.find()) {
            String oldValue = matcher.group(2);
            String updatedXmlContent = xmlContent.replace(oldValue, newValue);
            return updatedXmlContent;
        }

        return xmlContent;
    }
}
